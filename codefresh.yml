version: '1.0'
steps:
  BuildingDockerImage:
    title: Building Docker Image
    type: build
    image_name: platyplus-codefresh/graphql-server
    working_directory: ./
    tag: ${{CF_BRANCH_TAG_NORMALIZED}}
    dockerfile: Dockerfile
  StoreChart:
    title: Storing Helm Chart
    image: 'codefresh/cfstep-helm:2.9.1'
    environment:
     - ACTION=push
     - CHART_REF=charts/graphql-server
  DeployChart:
    image: 'codefresh/cfstep-helm:2.9.1'
    environment:
     - CHART_REF=charts/graphql-server
     - RELEASE_NAME=graphql
     - KUBE_CONTEXT=main@platyplus
     - VALUE_image_pullPolicy=Always
     - VALUE_image_tag=${{CF_BRANCH_TAG_NORMALIZED}}
     - VALUE_env_prismaServer=${{PRISMA_SERVER}}
     - VALUE_env_prismaPort=${{PRISMA_PORT}}
     - VALUE_env_prismaService=${{PRISMA_SERVICE}}
     - VALUE_env_prismaStage=${{PRISMA_STAGE}}
     - VALUE_env_prismaSecret=${{PRISMA_SECRET}}
     - VALUE_env_appSecret=${{APP_SECRET}}
     - VALUE_env_prismaManagementApiSecret=${{PRISMA_MANAGEMENT_API_SECRET}}
